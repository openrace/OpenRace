---

- name: selecting self built images
  set_fact:
   ui_image: "openrace/ui:{{ openrace.version }}"
   led_image: led_control
   core_image: race_core
  when: openrace.build_images

- name: selecting dockerhub images
  set_fact:
   ui_image: "openrace/ui:{{ openrace.version }}"
   led_image: "openrace/led_control:{{ openrace.version }}"
   core_image: "openrace/race_core:{{ openrace.version }}"
  when: not openrace.build_images

- name: Create an ui container
  docker_container:
    name: ui
    image: "{{ ui_image }}"
    recreate: yes
    restart_policy: "{{ openrace.restart_policy }}"
    networks:
      - name: openrace
    ports:
      "80:80"
    env:
      MQTT_WEBSOCKETS_HOST: mqtt:9001
  become: true
  tags:
     - ui

- name: Create OpenRace log directory
  file:
    path: /srv/openrace/log/
    state: directory
    owner: pi
    group: pi
    mode: 0777
  become: true

- name: Create OpenRace race archive directory
  file:
    path: /srv/openrace/archive/
    state: directory
    owner: pi
    group: pi
    mode: 0777
  become: true

- name: Create a led_control container
  docker_container:
    name: led_control
    image: "{{ led_image }}"
    recreate: yes
    restart_policy: "{{ openrace.restart_policy }}"
    networks:
      - name: openrace
    volumes:
      - "/srv/openrace/log:/app/log/:rw"
    env:
      MQTT_HOST: mqtt
      MQTT_USER: openrace
      MQTT_PASS: PASSWORD
      DEBUG: false
  become: true

- name: Check if LapRF is plugged in
  stat:
    path:  "{{ openrace.racerf_device }}"
  register: device
  tags:
     - core

- name: Create a race_core container with LapRF
  docker_container:
    name: race_core
    image: "{{ core_image }}"
    recreate: yes
    restart_policy: "{{ openrace.restart_policy }}"
    networks:
      - name: openrace
    volumes:
      - "/srv/openrace/log:/app/log/:rw"
      - "/srv/openrace/archive:/app/archive/:rw"
    devices:
      - "{{ openrace.racerf_device }}:{{ openrace.racerf_device }}"
    env:
      MQTT_HOST: mqtt
      MQTT_USER: openrace
      MQTT_PASS: PASSWORD
      DEBUG: false
  become: true
  when: device.stat.islnk is defined and device.stat.islnk
  tags:
     - core

- name: Create a race_core container without LapRF
  docker_container:
    name: race_core
    image: "{{ core_image }}"
    recreate: yes
    restart_policy: "{{ openrace.restart_policy }}"
    networks:
      - name: openrace
    volumes:
      - "/srv/openrace/log:/app/log/:rw"
      - "/srv/openrace/archive:/app/archive/:rw"
    env:
      MQTT_HOST: mqtt
      MQTT_USER: openrace
      MQTT_PASS: PASSWORD
      DEBUG: false
  become: true
  when: device.stat.islnk is not defined
  tags:
     - core
